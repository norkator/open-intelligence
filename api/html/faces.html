<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Intelligence platform simple web page for basic intelligence">
  <meta name="author" content="">
  <link rel="icon"
        href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACQAAAAkCAYAAADhAJiYAAACA0lEQVR4Ae3VAYQiURjA8cNgEMIiDMJicQiLMDgWh0UIixAOh8VgsTgMQoBwCLAIIYTFASCEMDiEEMIghMUifPfHw+fx6s2YHHf75wcY9Z733vfpf+mjFgaYY4WtscAMz7jGRQuRYAfxtEYfldfBBlJShhiVNIBY9nhBF200jRg9TPEGUY74htIFmEGUHI8IcK4QKQ4QZYhSDSHKK+ooWoQlRCm8Uw8QZYQAZQut3T4iLvJxDjHmqKLQ2qkMXqUQY4saqiqyzlQfJwvPfPCEDGM04eozpliif2LBa5zsDmJsoGtDlDFc/bLOS2QtWj8J13A2PnE9E4jyG64OEKUL3RRiPMPZCmLE0DVwhBhPcPXTekRD6HoQYwZnO4gRwa6BBG2c6yu+ow67GGIs4EyUS9a0bvJf/0MRxNjBWQ4xGrhU+sYu4SyDGLe4VF3fSfACMVLng1Zcz/d37DonZk0dO0hBS+gC7CFGC85qeIcY99DFeIN4ynED3aPXgVaNrNc4gK7luVNrNKGrWxcnwdnqOJyZWSES5BDLDj8QQhfg1ZqVAbxKIJ4ruUKML7jx2nmgg0JNIMoYAYpWwxyipChciAXsCX8P3/rYQpQpShdiArFkSHFrvegRYgyxgVgGqKQEB0hJOR5QaVcY4R3i6YAUIS5WDR1MkGFvXfkVxrhDiI/+7f4AfdpSa7k2LiwAAAAASUVORK5CYII=">

  <title>Intelligence - Faces</title>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

  <!-- Custom styles for this template -->
  <link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">

  <!-- Morris css -->
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.css">

  <!-- App own theme -->
  <!--suppress HtmlUnknownTarget -->
  <link rel="stylesheet" href="style.css">

</head>

<body style="background-color: #343a40">

<!-- Generic image view modal -->
<div class="modal fade bd-example-modal-lg" id="generic_image_modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="generic_modal_title">...</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p id="generic_modal_description" class="text-muted">
        </p>
        <img id="generic_modal_image" class="card-img-right"
             style="width: 100%; height: 100%;"
             alt="Generic modal image">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- sticky-top -->
<nav class="navbar navbar-dark sticky-top navbar-expand-lg bg-dark">
  <a class="navbar-brand col-sm-3 col-md-2 mr-0"
     style="font-family: 'Playfair Display', Georgia, 'Times New Roman', serif; font-size: 1.5rem;">
    <img
      src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACQAAAAkCAYAAADhAJiYAAACHklEQVR4Ae3WAWTjUBjA8UNRFMVQFMUwHIahCI7hMBTFUBTDYQiG4RAUBRSHAIaiKIrhAFAURVAURREERVAMRe+PfTzP+faSJsy2Pz9M0rcvSdPk26foq+PxeIkBZlhi+2qOKR5xXvYQVfiI4doa/TKG6WCDvEXwihpmALsdntBFG61XHnqYYA+zA+5OGaSCKcwS3KPieIkDpDAb5h1oCLNn1HOs08QCZndZF7mF2QiVE2+IqXX5vCwfTiDNCrxLF5Ai1w8GkLaoFXi3NpFC6r99FMoH+PsBEUK0lHW+Y4IF+soBr98a6BrSxtrWhlmorPMX0gFN66D3kM61gUJIQ2ubD7OVsk4Ks661fQLpURtoCcmztjVwgPSgrPMH0g5Va3sP0lQbKIYkp9keykfb4Qv8E79Q/882D9JcW4SISn5QtyBt38NATUixtmMCqVHiQG1IC23HCNJViQN1Ic20HZ8gBcoPWtZ6+v/RX8SkyNpWR4ysLezXGuwgXWoD1fAC6ca+XbGHawkurDXuIcUu13cEaYWK/YLveKbWaNlnGQkk32WgOlJIofLCn8Auxm9U7UuFZ0gb/R1Lf275yr5n8PADFw5nXupkvTXHMAv1I1K/lzOYBXnf8OYwW+Emwxp9bGE2OfW1cwy7CAGu0LAeCR6G2MBuUNQvq48UeUtwW/TP/RlGeIFrKQJUy3xS19DBGBF2kGIsEeJaBvnqQ/cPDxGlXpRi3oIAAAAASUVORK5CYII="
      width="36" height="36" class="d-inline-block align-top" alt="">
    Intelligence</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <div class="navbar-nav">
      <a class="nav-item nav-link" id="homeBtn" style="cursor: pointer;">Home</a>
      <a class="nav-item nav-link" id="camerasBtn" style="cursor: pointer;">Cameras</a>
      <a class="nav-item nav-link" id="platesBtn" style="cursor: pointer;">Plates</a>
      <a class="nav-item nav-link active" id="facesBtn" style="cursor: pointer;">Faces <span
        class="sr-only">(current)</span></a>
    </div>
  </div>
</nav>


<!-- Face image loading date control -->
<div class="d-flex justify-content-center flex-wrap mb-2" style="height: 100%">
  <div class="input-group mb-2" style="max-width: 300px;">
    <input id="selected_day_field" type="text" style="background-color: #343a40; color: #999999;" disabled class="form-control">
    <div class="input-group-append">
      <button class="btn btn-outline-info" type="button" id="load_earlier_day_btn">← Earlier</button>
      <button class="btn btn-outline-info" type="button" id="load_next_day_btn">Next →</button>
    </div>
  </div>
</div>


<!-- Face image viewer -->
<div id="faces_flex_viewer" class="d-flex justify-content-center flex-wrap" style="height: 100%">
</div>


<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->

<script
  src="https://code.jquery.com/jquery-3.4.1.min.js"
  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
  crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>

<!-- Morris chart -->
<script src="http://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.min.js"
        integrity="sha256-0rg2VtfJo3VUij/UY9X0HJP7NET6tgAY98aMOfwP0P8=" crossorigin="anonymous"></script>

<script>
  $(document).ready(function () {

    // Api url
    const apiUrl = String(window.location.href).replace('faces.html', '');

    $('#homeBtn').click(() => {
      document.location.href = apiUrl;
    });
    $('#camerasBtn').click(() => {
      document.location.href = apiUrl + "cameras.html";
    });
    $('#platesBtn').click(() => {
      document.location.href = apiUrl + "plates.html";
    });

    const generic_image_modal = $('#generic_image_modal');
    const generic_modal_title = $('#generic_modal_title');
    const generic_modal_description = $('#generic_modal_description');
    const generic_modal_image = $('#generic_modal_image');

    const selected_day_field = $('#selected_day_field');
    const load_earlier_day_btn = $('#load_earlier_day_btn');
    const load_next_day_btn = $('#load_next_day_btn');
    selected_day_field.val(new Date().toISOString().substr(0, 10));
    load_earlier_day_btn.on('click', function () {
      let date = new Date(selected_day_field.val());
      date.setDate(date.getDate() - 1);
      selected_day_field.val(date.toISOString().substr(0, 10));
      faces_flex_viewer.empty();
      loadFaceImages();
    });
    load_next_day_btn.on('click', function () {
      let date = new Date(selected_day_field.val());
      date.setDate(date.getDate() + 1);
      selected_day_field.val(date.toISOString().substr(0, 10));
      faces_flex_viewer.empty();
      loadFaceImages();
    });

    // Components
    let faces_flex_viewer = $('#faces_flex_viewer');
    faces_flex_viewer.on('click', 'img', function () {
      getObjectDetectionImageFileNameForCroppedImageName($(this).attr('id'));
    });


    // Refresh
    loadFaceImages();
    setInterval(() => {
      if (String(selected_day_field.val()) === String(new Date().toISOString().substring(0, 10))) {
        loadFaceImages();
      } else {
        console.info('Not current day, skipping auto loading run');
      }
    }, (60 * 1000));

    function loadFaceImages() {
      $.ajax({
        url: apiUrl + 'get/faces/for/day',
        type: 'POST',
        data: {
          selectedDate: selected_day_field.val()
        }
      }).done(function (data) {
        faces_flex_viewer.empty();
        data.images.forEach(imageData => {
          faces_flex_viewer.append(
            '<img id="' + imageData.file + '" title="' + imageData.title + '" src="' + imageData.image +
            '" style="max-height: 120px; max-width: 120px; cursor: pointer;" class="mr-1 ml-1 mt-1">'
          );
        });
      }).fail(function (error) {
      });
    }


    /**
     * Get object detection image name
     * @param cropped_image_name
     */
    function getObjectDetectionImageFileNameForCroppedImageName(cropped_image_name) {
      $.ajax({
        url: apiUrl + 'get/object/detection/image/for/cropped/image',
        type: 'POST',
        data: {
          croppedImageName: cropped_image_name
        },
      }).done(function (data) {
        console.log(data);
        getObjectDetectionImage(data.file_name);
      }).fail(function (error) {
        alert(error);
      });
    }

    /**
     * Load object_detection image for given file name
     * @param object_detection_image_file_name
     */
    function getObjectDetectionImage(object_detection_image_file_name) {
      $.ajax({
        url: apiUrl + 'get/object/detection/image',
        type: 'POST',
        data: {
          objectDetectionImageFileName: object_detection_image_file_name
        },
      }).done(function (data) {
        generic_image_modal.modal('show');
        generic_modal_title.text(object_detection_image_file_name);
        generic_modal_description.text('');
        generic_modal_image.attr("src", data.data);
      }).fail(function (error) {
        alert(error);
      });
    }
  });


</script>

</body>
</html>
