<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Intelligence platform simple web page for basic intelligence">
  <meta name="author" content="">
  <!-- <link rel="icon" href=""> -->

  <title>Intelligence</title>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

  <!-- Custom styles for this template -->
  <link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">

  <!-- Morris css -->
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.css">

  <style>
    h1, h2, h3, h4, h5, h6 {
      font-family: "Playfair Display", Georgia, "Times New Roman", serif;
    }

    .display-4 {
      font-size: 2.5rem;
    }

    @media (min-width: 768px) {
      .display-4 {
        font-size: 3rem;
      }
    }

    .card-img-right {
      height: 100%;
      border-radius: 0 3px 3px 0;
    }

    .box-shadow {
      box-shadow: 0 .25rem .75rem rgba(0, 0, 0, .05);
    }

    .intelligence-footer {
      padding: 2.5rem 0;
      color: #999;
      text-align: center;
      background-color: #f9f9f9;
      border-top: .05rem solid #e5e5e5;
    }

    .intelligence-footer p:last-child {
      margin-bottom: 0;
    }

    .zoom {
      transition: transform .2s;
      margin: 0 auto;
    }

    .zoom:hover {
      transform: scale(1.5);
    }
  </style>

</head>

<body>


<!-- Super resolution modal -->
<div class="modal fade bd-example-modal-lg" id="sr_image_modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="sr_modal_title">...</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p class="text-muted">
          This image is computed super resolution version.
        </p>
        <img id="sr_modal_image" class="card-img-right"
             style="width: 100%; height: 100%;"
             alt="Object detection image">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<div class="container">
  <header class="py-3" style="line-height: 1; border-bottom: 1px solid #e5e5e5;">
    <div class="row flex-nowrap justify-content-between align-items-center">
      <div class="col-4">
        <div id="talk_content_div">
          <button id="activate_talk_btn" type="button" class="btn btn-outline-secondary btn-sm">Talk</button>
        </div>
      </div>
      <div class="col-4 text-center" style="text-decoration: none;">
        <a class="text-dark"
           style="font-family: 'Playfair Display', Georgia, 'Times New Roman', serif; font-size: 2.25rem;">Intelligence</a>
      </div>
      <div class="col-4 d-flex justify-content-end align-items-center">
        <a id="resource_monitor" class="badge badge-light" style="cursor: pointer;"></a>
      </div>
    </div>
  </header>

  <!--
  <div class="py-1 mb-2" style="position: relative; z-index: 2; height: 2.75rem; overflow-y: hidden;">
    <nav class="nav d-flex justify-content-center">
      <a class="p-2 text-muted" href="#">Option A</a>
      <a class="p-2 text-muted" href="#">Option B</a>
      <a class="p-2 text-muted" href="#">Option C</a>
      <a class="p-2 text-muted" href="#">Option D</a>
      <a class="p-2 text-muted" href="#">Option E</a>
      <a class="p-2 text-muted" href="#">Option F</a>
    </nav>
  </div>
  -->

  <div class="jumbotron p-3 p-md-5 text-white rounded bg-dark">
    <div class="row">
      <div class="col-md-6">
        <h1 class="display-4 font-italic">What I've seen recently</h1>
        <p class="lead my-3">Here's latest detection image which in I've noticed some interesting objects.
          Also.. below you can find activity and label statistics.
        </p>
        <!-- <p class="lead mb-0"><a href="#" class="text-white font-weight-bold">Link...</a></p> -->
      </div>
      <div class="col-md-6">
        <img id="object_detection_image" class="card-img-right zoom"
             style="width: 100%; height: 100%;"
             alt="Object detection image">
      </div>
    </div>
  </div>


  <div class="row mb-2">
    <div class="col-md-12">
      <div class="input-group mb-3">
        <div class="input-group-prepend">
          <span class="input-group-text" id="basic-addon1">Selected day</span>
        </div>
        <input id="selected_day_field" type="date" class="form-control" placeholder="Change day"
               aria-label="Day change">
        <div class="input-group-append">
          <button class="btn btn-outline-secondary" type="button" id="load_day_btn">Load</button>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card flex-md-row mb-4 box-shadow h-md-250">
        <div class="card-body d-flex flex-column align-items-center">
          <strong class="d-inline-block mb-2 text-primary">Activity</strong>
          <div id="activity_chart" style="max-width: 400px; max-height: 200px;"></div>
          <p class="card-text mb-auto">Visualizing hourly raw activity for selected day.</p>
          <div class="mb-1 text-muted">Hover on top to see details.</div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card flex-md-row mb-4 box-shadow h-md-250">
        <div class="card-body d-flex flex-column align-items-center">
          <strong class="d-inline-block mb-2 text-success">Labels</strong>
          <div id="donut_chart" style="max-width: 400px; max-height: 200px; height: 200px; cursor: pointer;"></div>
          <p class="card-text mb-auto">Visualizing count of different seen 'labels'.</p>
          <div class="mb-1 text-muted">You can hover on top of it to see
            names and counts.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<main role="main" class="container">

  <!-- Label image viewer -->
  <div class="row">
    <div class="col-md-12">
      <div class="card mb-4">
        <div class="card-header">
          Label cropped image viewer
        </div>
        <div id="label_image_flex_viewer" class="d-flex flex-wrap mt-2 mb-2">
        </div>
        <div class="card-footer">
          <small id="loaded_label_info" class="text-muted">No label selected</small>
        </div>
      </div>
    </div>
  </div>


  <div class="row mb-2">
    <div class="col-md-6">
      <div class="card flex-md-row mb-4 box-shadow h-md-250" style="height: 100%">
        <div class="card-body d-flex flex-column align-items-center">
          <strong class="d-inline-block mb-2 text-primary">License plates</strong>
          <div id="licence_plate_flex_viewer" class="d-flex flex-wrap mt-2 mb-2" style="height: 100%">
          </div>
          <div class="mb-1 text-muted">License plate detections</div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card flex-md-row mb-4 box-shadow h-md-250" style="height: 100%">
        <div class="card-body d-flex flex-column align-items-center">
          <strong class="d-inline-block mb-2 text-success">Faces</strong>
          <div id="faces_flex_viewer" class="d-flex flex-wrap mt-2 mb-2" style="height: 100%">
          </div>
          <div class="mb-1 text-muted">Face detections</div>
        </div>
      </div>
    </div>
  </div>


  <!-- Face sorting interface -->
  <div class="row">
    <div class="col-md-12">
      <div class="card flex-md-row mb-4 box-shadow h-md-250">
        <div class="card-body d-flex flex-column align-items-center">
          <strong class="d-inline-block mb-2 text-primary">Person image grouping</strong>
          <div id="face_grouping_flex_viewer" class="d-flex flex-wrap mt-2 mb-2" style="height: 100%">
          </div>
          <div class="mb-1 text-muted">Click image and select who is in the image. This is used on training.</div>
          <div id="face_grouping_names_flex_viewer" class="d-flex flex-wrap mt-2 mb-2" style="height: 100%">
          </div>
          <button id="train_face_model_btn" type="button" class="btn btn-outline-secondary btn-sm">Train model
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- One week activity -->
  <div class="row">
    <div class="col-md-12">
      <div class="card flex-md-row mb-4 box-shadow h-md-250">
        <div class="card-body d-flex flex-column align-items-center">
          <strong class="d-inline-block mb-2 text-primary">Activity (One week)</strong>
          <div id="activity_week_chart" style="width: 100%; max-height: 200px;"></div>
          <p class="card-text mb-auto">Visualizing one week hourly raw activity.</p>
          <div class="mb-1 text-muted">Hover on top to see details.</div>
          <button id="load_weekly_data_btn" type="button" class="btn btn-outline-secondary btn-sm">Load weekly data
          </button>
        </div>
      </div>
    </div>
  </div>

</main>

<footer class="intelligence-footer">
  <p>Intelligence <a href="https://github.com/norkator/Open-Intelligence">Github</a>.</p>
  <p>
    <a href="#">Back to top</a>
  </p>
</footer>

<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->

<script
  src="https://code.jquery.com/jquery-3.4.1.min.js"
  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
  crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>

<!-- Morris chart -->
<script src="http://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.min.js"
        integrity="sha256-0rg2VtfJo3VUij/UY9X0HJP7NET6tgAY98aMOfwP0P8=" crossorigin="anonymous"></script>

<!-- Adds zooming effect -->
<script src="https://cdn.jsdelivr.net/npm/wheelzoom@4.0.1/wheelzoom.js"
        integrity="sha256-fhru0y6L8Knyrjj57vB7/npV5IUyq6Tvo8g0qoceVwQ=" crossorigin="anonymous"></script>

<script>
  $(document).ready(function () {

    // Api url
    const apiUrl = 'http://localhost:4300';

    // Variables
    let loadedLabel = null;
    let faceGroupingNames = [];
    let loadedFaceGroupingImage = null;

    // Init voice (text to speech)
    let msg = new SpeechSynthesisUtterance();
    let bool_speaking = false;
    msg.volume = 1; // 0 to 1
    msg.rate = 1; // 0.1 to 10
    msg.pitch = 1; //0 to 2
    msg.lang = 'en-US';
    window.speechSynthesis.onvoiceschanged = function () {
      let voices = window.speechSynthesis.getVoices();
      msg.voice = voices[2];
      msg.voiceURI = voices[2].voiceURI
    };
    msg.onend = function (e) {
      bool_speaking = false;
    };

    // Init zoom effect to all img elements
    wheelzoom(document.querySelector('img.zoom'));

    // jQuery references to elements
    const label_image_flex_viewer = $('#label_image_flex_viewer');
    const loaded_label_info = $('#loaded_label_info');
    const talk_content_div = $('#talk_content_div');
    const activate_talk_btn = $('#activate_talk_btn').click(() => {
      talk_content_div.empty();
      talk_content_div.append('<span class="badge badge-pill badge-success">Talk enabled</span>');
      voiceIntelligence();
    });
    const load_weekly_data_btn = $('#load_weekly_data_btn');
    load_weekly_data_btn.click(() => {
      loadWeeklyData();
      load_weekly_data_btn.remove();
    });
    const resource_monitor = $('#resource_monitor');
    const sr_image_modal = $('#sr_image_modal');
    label_image_flex_viewer.on('click', 'img', function () {
      getSrModalData($(this).attr('id'));
    });
    const sr_modal_title = $('#sr_modal_title');
    const sr_modal_image = $('#sr_modal_image');
    const selected_day_field = $('#selected_day_field');
    selected_day_field.val(new Date().toISOString().substr(0, 10));
    const load_day_btn = $('#load_day_btn');
    load_day_btn.on('click', function () {
      loadData();
    });
    const licence_plate_flex_viewer = $('#licence_plate_flex_viewer');
    const faces_flex_viewer = $('#faces_flex_viewer');

    const face_grouping_names_flex_viewer = $('#face_grouping_names_flex_viewer');
    face_grouping_names_flex_viewer.on('click', 'button', function () {
      const name = $(this).attr('id');
      console.log(loadedFaceGroupingImage);
      $.ajax({
        url: apiUrl + '/move/face/grouping/image',
        type: 'POST',
        data: {
          name: name,
          rectFileName: loadedFaceGroupingImage
        },
      }).done(function (data) {
        face_grouping_flex_viewer.find('img[id="' + loadedFaceGroupingImage + '"]').remove();
        face_grouping_names_flex_viewer.empty();
      }).fail(function (error) {
        alert(error);
      });
    });
    const face_grouping_flex_viewer = $('#face_grouping_flex_viewer');
    face_grouping_flex_viewer.on('click', 'img', function () {
      loadedFaceGroupingImage = $(this).attr('id');
      face_grouping_names_flex_viewer.empty();
      faceGroupingNames.forEach(name => {
        face_grouping_names_flex_viewer.append(
          '<button id="' + name + '" type="button" class="btn btn-outline-secondary btn-sm mr-2">' + name + '</button>'
        )
      });
      face_grouping_names_flex_viewer.append(
        '<button id="delete" type="button" class="btn btn-outline-danger btn-sm mr-2">delete</button>'
      )
    });
    const train_face_model_btn = $('#train_face_model_btn');
    train_face_model_btn.on('click', function () {
      if (confirm("Send train face model training action?")) {
        trainFaceModel();
      }
    });

    // Initial data load
    loadData();

    // Refresh
    setInterval(() => {
      loadData();
    }, (60 * 1000));

    function loadData() {

      // Image
      $.ajax({
        url: apiUrl + '/get/latest/object/detection/image',
        type: 'GET',
      }).done(function (data) {
        // console.log('Loaded object detection image');
        $("#object_detection_image").attr("src", data.data);
      });

      // Intelligence, includes all one day statistics, and valid detections
      $.ajax({
        url: apiUrl + '/get/intelligence',
        type: 'POST',
        data: {
          selectedDate: selected_day_field.val()
        }
      }).done(function (data) {
        // console.log('Loaded intelligence data');

        resource_monitor.text(/*'CPU ' + data.performance.loadAvg +*/'MEM ' + data.performance.memUse);

        // Donut labels
        $('#donut_chart').empty();
        new Morris.Donut({
          element: 'donut_chart',
          data: data.donut,
          resize: true,
          parseTime: false
        }).on('click', function (i, row) {
          const label_ = data.donut[i].label;
          loaded_label_info.text('You chose ' + label_ + ' label images.');
          loadedLabel = label_;
          loadLabelImages(label_);
        });

        // Activity chart
        $('#activity_chart').empty();
        new Morris.Bar({
          element: 'activity_chart',
          data: data.activity.data,
          xkey: data.activity.xkey,
          ykeys: data.activity.ykeys,
          labels: data.activity.labels,
          hideHover: true,
          resize: true,
          parseTime: false
        });
      });

      // License plate detection data, images and plate strings
      $.ajax({
        url: apiUrl + '/get/license/plate/detections',
        type: 'POST',
        data: {
          selectedDate: selected_day_field.val()
        }
      }).done(function (data) {
        // Plates
        licence_plate_flex_viewer.empty();
        data.licensePlates.forEach(licensePlate => {
          licence_plate_flex_viewer.append(
            '<div style="margin: 5px;">' +
            '<img id="' + licensePlate.file + '" title="' + licensePlate.title + '" style="cursor: zoom-in; max-width: 120px; max-height: 120px;" src="' + licensePlate.image + '">' +
            '<p class="lead text-center" style="font-weight: bold; background-color: #f4f4f4;">' + licensePlate.detectionResult + '</p>' +
            '</div>'
          );
          wheelzoom(document.getElementById(licensePlate.file));
        });
      });

      $.ajax({
        url: apiUrl + '/get/faces',
        type: 'POST',
        data: {
          selectedDate: selected_day_field.val()
        }
      }).done(function (data) {
        // Faces
        faces_flex_viewer.empty();
        data.faces.forEach(face => {
          faces_flex_viewer.append(
            '<div style="margin: 5px;">' +
            '<img id="' + face.file + '" title="' + face.title + '" style="cursor: zoom-in; max-width: 120px; max-height: 120px;" src="' + face.image + '">' +
            '<p class="lead text-center" style="font-weight: bold; background-color: #f4f4f4; font-size: 10pt;">' + face.detectionResult + '</p>' +
            '</div>'
          );
          wheelzoom(document.getElementById(face.file));
        });
      });


      // Load face grouping images
      $.ajax({
        url: apiUrl + '/get/face/grouping/images',
        type: 'GET',
      }).done(function (data) {
        console.log(data);
        // Faces
        face_grouping_flex_viewer.empty();
        faceGroupingNames = data.names;
        data.images.forEach(imageData => {
          face_grouping_flex_viewer.append(
            '<img id="' + imageData.file + '" title="' + imageData.title + '" style="cursor: pointer; max-width:120px; max-height:120px; width: auto; height: auto;" class="zoom" src="' + imageData.image + '">'
          );
          wheelzoom(document.getElementById(imageData.file));
        });
      });
    }

    function loadWeeklyData() {

      $.ajax({
        url: apiUrl + '/get/weekly/intelligence',
        type: 'GET',
      }).done(function (data) {

        // Activity week chart
        $('#activity_week_chart').empty();
        new Morris.Bar({
          element: 'activity_week_chart',
          data: data.activityWeek.data,
          xkey: data.activityWeek.xkey,
          ykeys: data.activityWeek.ykeys,
          labels: data.activityWeek.labels,
          hideHover: true,
          resize: true,
          parseTime: false
        });
      });
    }

    function loadLabelImages(label) {
      label_image_flex_viewer.empty();
      label_image_flex_viewer.append('<div id="loading_indicator_place_holder" style="width: 100%"></div>');
      const loading_indicator_place_holder = $('#loading_indicator_place_holder');
      loading_indicator_place_holder.append('<div id="label_image_loading_indicator" ' +
        'style="width: 100%" class="text-center">' +
        '<div class="spinner-border" role="status">' +
        '<span class="sr-only">Loading...</span>' +
        '</div>' +
        '</div>');
      $.ajax({
        url: apiUrl + '/get/label/images',
        type: 'POST',
        data: {
          selectedDate: selected_day_field.val(),
          label: label
        },
      }).done(function (data) {
        data.images.forEach(imageData => {
          loading_indicator_place_holder.empty();
          label_image_flex_viewer.append(
            '<img id="' + imageData.file + '" title="' + imageData.title + '" style="cursor: pointer; max-width:120px; max-height:120px; width: auto; height: auto;" class="zoom" src="' + imageData.image + '">'
          );
          wheelzoom(document.getElementById(imageData.file));
        });
      }).fail(function (error) {
        loaded_label_info.text(error.status + ' ' + error.statusText);
        loading_indicator_place_holder.empty();
      });
    }


    function voiceIntelligence() {
      run(); // Initial run
      setInterval(function () {
        run();
      }, (30 * 1000));

      function run() {
        if (!bool_speaking) {
          $.ajax({
            url: apiUrl + '/get/voice/intelligence',
            type: 'GET',
          }).done(function (data) {
            if (data.message !== '') {
              bool_speaking = true;
              msg.text = data.message;
              speechSynthesis.speak(msg);
            }
          }).fail(function (error) {
            bool_speaking = false;
          });
        }
      }
    }


    function getSrModalData(image_file_name) {
      $.ajax({
        url: apiUrl + '/get/super/resolution/image',
        type: 'POST',
        data: {
          label: loadedLabel,
          imageFile: image_file_name
        },
      }).done(function (data) {
        sr_image_modal.modal('show');
        sr_modal_title.text(loadedLabel + ' - ' + image_file_name);
        sr_modal_image.attr("src", data.data);
      }).fail(function (error) {
        bool_speaking = false;
      });
    }


    function trainFaceModel() {
      $.ajax({
        url: apiUrl + '/train/face/model',
        type: 'GET',
      }).done(function (data) {
        alert(data);
      }).fail(function (error) {
        alert(error);
      });
    }


  });


</script>

</body>
</html>
