<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Intelligence platform simple web page for basic intelligence">
  <meta name="author" content="">
  <link rel="icon"
        href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACQAAAAkCAYAAADhAJiYAAACA0lEQVR4Ae3VAYQiURjA8cNgEMIiDMJicQiLMDgWh0UIixAOh8VgsTgMQoBwCLAIIYTFASCEMDiEEMIghMUifPfHw+fx6s2YHHf75wcY9Z733vfpf+mjFgaYY4WtscAMz7jGRQuRYAfxtEYfldfBBlJShhiVNIBY9nhBF200jRg9TPEGUY74htIFmEGUHI8IcK4QKQ4QZYhSDSHKK+ooWoQlRCm8Uw8QZYQAZQut3T4iLvJxDjHmqKLQ2qkMXqUQY4saqiqyzlQfJwvPfPCEDGM04eozpliif2LBa5zsDmJsoGtDlDFc/bLOS2QtWj8J13A2PnE9E4jyG64OEKUL3RRiPMPZCmLE0DVwhBhPcPXTekRD6HoQYwZnO4gRwa6BBG2c6yu+ow67GGIs4EyUS9a0bvJf/0MRxNjBWQ4xGrhU+sYu4SyDGLe4VF3fSfACMVLng1Zcz/d37DonZk0dO0hBS+gC7CFGC85qeIcY99DFeIN4ynED3aPXgVaNrNc4gK7luVNrNKGrWxcnwdnqOJyZWSES5BDLDj8QQhfg1ZqVAbxKIJ4ruUKML7jx2nmgg0JNIMoYAYpWwxyipChciAXsCX8P3/rYQpQpShdiArFkSHFrvegRYgyxgVgGqKQEB0hJOR5QaVcY4R3i6YAUIS5WDR1MkGFvXfkVxrhDiI/+7f4AfdpSa7k2LiwAAAAASUVORK5CYII=">

  <title>Intelligence</title>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

  <!-- Custom styles for this template -->
  <link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">

  <!-- Morris css -->
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.css">

  <!-- Jcrop image cropper -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-jcrop/2.0.4/css/Jcrop.min.css">

  <!-- App own theme -->
  <!--suppress HtmlUnknownTarget -->
  <link rel="stylesheet" href="style.css">

</head>

<body>


<!-- Instance modal -->
<div class="modal" tabindex="-1" id="instance_modal" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Instances</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <table class="table">
          <thead class="thead-dark">
          <tr>
            <th scope="col">ID</th>
            <th scope="col">Process name</th>
            <th scope="col">Hardware</th>
            <th scope="col">Updated</th>
          </tr>
          </thead>
          <tbody id="instance_modal_content">
          <!-- Content is appended here -->
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Generic image view modal -->
<div class="modal fade bd-example-modal-lg" id="generic_image_modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="generic_modal_title">...</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id="generic_modal_description">
        </div>
        <img id="generic_modal_image" class="card-img-right"
             style="width: 100%; height: 100%;"
             alt="Generic modal image">
      </div>
      <div class="modal-footer">
        <button id="downloadGenericModalImageBtn" type="button" class="btn btn-outline-secondary">
          Download
        </button>
        <button id="downloadGenericModalSrImageBtn" type="button" class="btn btn-outline-secondary">
          Download SR
        </button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<!-- Licence plate manager modal -->
<div class="modal fade bd-example-modal-lg" id="licence_plate_manager_modal" tabindex="-1" role="dialog"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="licence_plate_manager_modal_title">Manage licence plates</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <table class="table table-striped">
          <thead>
          <tr>
            <th>ID</th>
            <th>Licence plate</th>
            <th>Owner name</th>
            <th>Enabled</th>
            <th>Delete</th>
          </tr>
          </thead>
          <tbody id="licence_plate_manager_modal_table">
          <!-- Content is appended here dynamically -->
          </tbody>
        </table>
        <div class="mb-2">
          <a data-toggle="collapse" href="#add_licence_plate_collapse" role="button" aria-expanded="false"
             aria-controls="collapseExample">
            Add new licence plate
          </a>
          <div class="collapse" id="add_licence_plate_collapse">
            <form class="mt-2">
              <div class="form-group">
                <label for="new_plate_licence_plate">Licence plate</label>
                <input type="text" class="form-control" id="new_plate_licence_plate" aria-describedby="emailHelp">
                <small class="form-text text-muted">Input without lines, example ABC123
                </small>
              </div>
              <div class="form-group">
                <label for="new_plate_owner_name">Owner name</label>
                <input type="text" class="form-control" id="new_plate_owner_name" aria-describedby="emailHelp">
                <small class="form-text text-muted">Give full owner name
                </small>
              </div>
              <div class="form-group form-check">
                <input type="checkbox" class="form-check-input" id="new_plate_enabled">
                <label class="form-check-label" for="new_plate_enabled">Enabled</label>
              </div>
            </form>
            <button id="new_plate_add_btn" class="btn btn-primary">Add plate</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="licence_plate_manager_modal_save_changes_btn" type="button" class="btn btn-primary"
                data-dismiss="modal">Save and close
        </button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- sticky-top -->
<nav class="navbar navbar-dark sticky-top navbar-expand-lg bg-dark">
  <a class="navbar-brand col-sm-3 col-md-2 mr-0"
     style="font-family: 'Playfair Display', Georgia, 'Times New Roman', serif; font-size: 1.5rem;">
    <img
      src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACQAAAAkCAYAAADhAJiYAAACHklEQVR4Ae3WAWTjUBjA8UNRFMVQFMUwHIahCI7hMBTFUBTDYQiG4RAUBRSHAIaiKIrhAFAURVAURREERVAMRe+PfTzP+faSJsy2Pz9M0rcvSdPk26foq+PxeIkBZlhi+2qOKR5xXvYQVfiI4doa/TKG6WCDvEXwihpmALsdntBFG61XHnqYYA+zA+5OGaSCKcwS3KPieIkDpDAb5h1oCLNn1HOs08QCZndZF7mF2QiVE2+IqXX5vCwfTiDNCrxLF5Ai1w8GkLaoFXi3NpFC6r99FMoH+PsBEUK0lHW+Y4IF+soBr98a6BrSxtrWhlmorPMX0gFN66D3kM61gUJIQ2ubD7OVsk4Ks661fQLpURtoCcmztjVwgPSgrPMH0g5Va3sP0lQbKIYkp9keykfb4Qv8E79Q/882D9JcW4SISn5QtyBt38NATUixtmMCqVHiQG1IC23HCNJViQN1Ic20HZ8gBcoPWtZ6+v/RX8SkyNpWR4ysLezXGuwgXWoD1fAC6ca+XbGHawkurDXuIcUu13cEaYWK/YLveKbWaNlnGQkk32WgOlJIofLCn8Auxm9U7UuFZ0gb/R1Lf275yr5n8PADFw5nXupkvTXHMAv1I1K/lzOYBXnf8OYwW+Emwxp9bGE2OfW1cwy7CAGu0LAeCR6G2MBuUNQvq48UeUtwW/TP/RlGeIFrKQJUy3xS19DBGBF2kGIsEeJaBvnqQ/cPDxGlXpRi3oIAAAAASUVORK5CYII="
      width="36" height="36" class="d-inline-block align-top" alt="">
    Intelligence</a>
  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <div class="navbar-nav">
      <a class="nav-item nav-link active" style="cursor: pointer;">Home <span class="sr-only">(current)</span></a>
      <a class="nav-item nav-link" id="camerasBtn" style="cursor: pointer;">Cameras</a>
      <a class="nav-item nav-link" id="platesBtn" style="cursor: pointer;">Plates</a>
      <a class="nav-item nav-link" id="facesBtn" style="cursor: pointer;">Faces</a>
      <a class="nav-item nav-link" id="trainingBtn" style="cursor: pointer;">Training</a>
    </div>
  </div>
  <form class="form-inline my-2 my-lg-0">
    <a id="show_instances_btn" class="badge badge-light mr-2" style="cursor: pointer;"></a>
    <a id="storage_use_monitor" class="badge badge-light mr-2" style="cursor: pointer;"></a>
    <a id="resource_monitor" class="badge badge-light mr-4" style="cursor: pointer;"></a>
    <div id="talk_content_div">
      <button id="activate_talk_btn" type="button" class="btn btn-outline-light btn-sm">Talk</button>
    </div>
    <button class="navbar-toggler ml-2" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
  </form>


</nav>


<div class="container">
  <div class="jumbotron p-3 p-md-5 text-white rounded bg-dark mt-2">
    <div class="row">
      <div class="col-md-6">
        <h1 class="display-4 font-italic">What I've seen recently</h1>
        <p class="lead my-3">Here's latest detection image which in I've noticed some interesting objects.
          Also.. below you can find activity and label statistics.
        </p>
      </div>
      <div class="col-md-6">
        <div id="object_detection_image_container">
        </div>
      </div>
    </div>
  </div>

  <div class="row mb-2">
    <div class="col-md-12">
      <div class="input-group mb-3">
        <div class="input-group-prepend">
          <span class="input-group-text" id="basic-addon1">Selected day</span>
        </div>
        <input id="selected_day_field" type="date" class="form-control" placeholder="Change day"
               aria-label="Day change">
        <div class="input-group-append">
          <button class="btn btn-outline-secondary" type="button" id="load_day_btn">Load</button>
          <button class="btn btn-outline-info" type="button" id="load_earlier_day_btn">← Earlier</button>
          <button class="btn btn-outline-info" type="button" id="load_next_day_btn">Next →</button>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card flex-md-row mb-4 box-shadow h-md-250">
        <div class="card-body d-flex flex-column align-items-center">
          <strong class="d-inline-block mb-2 text-primary">Activity</strong>
          <div id="activity_chart" style="max-width: 400px; max-height: 200px;"></div>
          <p class="card-text mb-auto">Visualizing hourly raw activity for selected day.</p>
          <div class="mb-1 text-muted">Hover on top to see details.</div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card flex-md-row mb-4 box-shadow h-md-250">
        <div class="card-body d-flex flex-column align-items-center">
          <strong class="d-inline-block mb-2 text-success">Labels</strong>
          <div id="donut_chart" style="max-width: 400px; max-height: 200px; height: 200px; cursor: pointer;"></div>
          <p class="card-text mb-auto">Visualizing count of different seen 'labels'.</p>
          <div class="mb-1 text-muted">You can hover on top of it to see
            names and counts.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<main role="main" class="container">

  <!-- Label image viewer -->
  <div class="row">
    <div class="col-md-12">
      <div class="card mb-2">
        <div class="card-header">
          Label cropped image viewer
        </div>
        <div id="label_image_flex_viewer" class="d-flex flex-wrap mt-2 mb-2">
        </div>
        <div class="card-footer">
          <small id="loaded_label_info" class="text-muted">No label selected</small>
        </div>
      </div>
    </div>
  </div>


  <div class="row mb-2">
    <div class="col-md-6 mt-2">
      <div class="card flex-md-row mb-4 box-shadow h-md-250"
           style="height: 100%; max-height: 500px; overflow-y: scroll;">
        <div class="card-body d-flex flex-column align-items-center">
          <strong class="d-inline-block mb-2 text-primary">Some known license plates</strong>
          <div id="licence_plate_flex_viewer" class="d-flex flex-wrap mt-2 mb-2">
          </div>
          <div class="mb-1 text-muted">License plate detections</div>
          <button id="manage_licence_plates_btn" type="button" class="btn btn-outline-secondary btn-sm mt-2 mb-2"
                  style="font-size: 10px;">Manage licence plates
          </button>
        </div>
      </div>
    </div>
    <div class="col-md-6 mt-2">
      <div class="card flex-md-row mb-4 box-shadow h-md-250"
           style="height: 100%; max-height: 500px; overflow-y: scroll;">
        <div class="card-body d-flex flex-column align-items-center">
          <strong class="d-inline-block mb-2 text-success">Faces | Persons</strong>
          <div id="faces_flex_viewer" class="d-flex flex-wrap mt-2 mb-2">
          </div>
          <div class="mb-1 text-muted">Face detections</div>
        </div>
      </div>
    </div>
  </div>


  <!-- Face sorting interface -->
  <div class="row">
    <div class="col-md-12">
      <div class="card flex-md-row mb-2 box-shadow h-md-250">
        <div class="card-body d-flex flex-column align-items-center">
          <strong class="d-inline-block mb-2 text-primary">Person image grouping</strong>
          <div id="face_grouping_flex_viewer" class="d-flex flex-wrap mt-2 mb-2" style="height: 100%">
          </div>
          <div class="mb-1 text-muted">Click image and select who is in the image. This is used on training.</div>
          <div id="face_grouping_names_flex_viewer" class="d-flex flex-wrap mt-2 mb-2" style="height: 100%">
          </div>
          <button id="train_face_model_btn" type="button" class="btn btn-outline-secondary btn-sm"
                  style="font-size: 10px;">Train model
          </button>
          <button id="load_more_face_btn" type="button" class="btn btn-outline-primary btn-sm mt-2"
                  style="font-size: 10px;">Load more
          </button>
          <button id="delete_all_visible_faces_btn" style="font-size: 10px;" type="button"
                  class="btn btn-outline-danger btn-sm mt-2">
            Delete all visible
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- One week activity -->
  <div class="row mt-2">
    <div class="col-md-12">
      <div class="card flex-md-row mb-4 box-shadow h-md-250">
        <div class="card-body d-flex flex-column align-items-center">
          <strong class="d-inline-block mb-2 text-primary">Activity (One week)</strong>
          <div id="activity_week_chart" style="width: 100%; max-height: 200px;"></div>
          <p class="card-text mb-auto">Visualizing one week hourly raw activity.</p>
          <div class="mb-1 text-muted">Hover on top to see details.</div>
          <button id="load_weekly_data_btn" type="button" class="btn btn-outline-secondary btn-sm"
                  style="font-size: 10px;">Load weekly data
          </button>
        </div>
      </div>
    </div>
  </div>

</main>

<footer class="intelligence-footer">
  <p>Intelligence <a href="https://github.com/norkator/Open-Intelligence">Github</a>.</p>
  <p>
    <a href="#">Back to top</a>
  </p>
  <button id="disable_polls_btn" style="font-size: 10px;" type="button" class="btn btn-outline-danger btn-sm">Disable
    polls
  </button>
</footer>

<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->

<script
  src="https://code.jquery.com/jquery-3.4.1.min.js"
  integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
  crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>

<!-- Morris chart -->
<script src="http://cdnjs.cloudflare.com/ajax/libs/raphael/2.1.0/raphael-min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.min.js"
        integrity="sha256-0rg2VtfJo3VUij/UY9X0HJP7NET6tgAY98aMOfwP0P8=" crossorigin="anonymous"></script>

<!-- Adds zooming effect -->
<script src="https://cdn.jsdelivr.net/npm/wheelzoom@4.0.1/wheelzoom.js"
        integrity="sha256-fhru0y6L8Knyrjj57vB7/npV5IUyq6Tvo8g0qoceVwQ=" crossorigin="anonymous"></script>

<!-- Jcrop image cropper -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-jcrop/2.0.4/js/Jcrop.min.js"></script>

<script src="./common.js"></script>

<script>
  $(document).ready(function () {

    // Api url
    const apiUrl = window.location.href;
    SetCommonApiUrl(apiUrl);

    // Variables
    let pollInterval = null;
    let pollsEnabled = true;
    let loadedLabel = null;
    let faceGroupingNames = [];
    let loadedFaceGroupingImage = null;
    let genericModalOpenedImageLabelName = null;
    let genericModalOpenedImageFileName = null;
    let jcrop_reference = null;

    // Init voice (text to speech)
    let msg = null;
    let bool_speaking = false;
    try {
      msg = new SpeechSynthesisUtterance();
      msg.volume = 1; // 0 to 1
      msg.rate = 1; // 0.1 to 10
      msg.pitch = 1; //0 to 2
      msg.lang = 'en-US';
      window.speechSynthesis.onvoiceschanged = function () {
        let voices = window.speechSynthesis.getVoices();
        msg.voice = voices[2];
        msg.voiceURI = voices[2].voiceURI
      };
      msg.onend = function (e) {
        bool_speaking = false;
      };
    } catch (e) {
      console.log(e);
    }

    // Sound files
    let cursorClick01Sound = new Audio("/sounds/cursor_click_01.wav");

    // Init zoom effect to all img elements
    wheelzoom(document.querySelector('img.zoom'));

    const object_detection_image_container = $('#object_detection_image_container');
    const label_image_flex_viewer = $('#label_image_flex_viewer');
    const loaded_label_info = $('#loaded_label_info');
    const talk_content_div = $('#talk_content_div');
    const activate_talk_btn = $('#activate_talk_btn').click(() => {
      talk_content_div.empty();
      talk_content_div.append('<span class="badge badge-pill badge-success">Talk enabled</span>');
      voiceIntelligence();
    });
    const load_weekly_data_btn = $('#load_weekly_data_btn');
    load_weekly_data_btn.click(() => {

      loadWeeklyData();
      load_weekly_data_btn.remove();
    });

    const show_instances_btn = $('#show_instances_btn');
    show_instances_btn.on('click', function () {
      getInstanceDetails();
    });
    const instance_modal = $('#instance_modal');
    const instance_modal_content = $('#instance_modal_content');

    const storage_use_monitor = $('#storage_use_monitor');
    const resource_monitor = $('#resource_monitor');
    const generic_image_modal = $('#generic_image_modal');
    generic_image_modal.on('shown.bs.modal', function () {
      generic_modal_image.Jcrop({
        boxWidth: generic_modal_image.width(),
        onChange: function (c) {
        },
        onSelect: function (c) {
          // console.log('x=' + c.x + ' y=' + c.y + ' x2=' + c.x2 + ' y2=' + c.y2);
          // console.log('w=' + c.w + ' h=' + c.h)
        }
      });
    });
    generic_image_modal.on('hidden.bs.modal', function () {
      jcrop_reference = generic_modal_image.data('Jcrop');
      jcrop_reference.destroy();
    });
    let startTime, endTime, longPress;
    label_image_flex_viewer.on('click', 'img', function () {
      if (longPress) {
        getObjectDetectionImageFileNameForCroppedImageName($(this).attr('id'));
      } else {
        getSrModalData($(this).attr('id'));
      }
    });
    label_image_flex_viewer.on('mousedown', 'img', function () {
      startTime = new Date().getTime();
    });
    label_image_flex_viewer.on('mouseup', 'img', function () {
      endTime = new Date().getTime();
      longPress = (endTime - startTime > 500);
    });

    const generic_modal_title = $('#generic_modal_title');
    const generic_modal_description = $('#generic_modal_description');
    const generic_modal_image = $('#generic_modal_image');
    const downloadGenericModalImageBtn = $('#downloadGenericModalImageBtn');
    const downloadGenericModalSrImageBtn = $('#downloadGenericModalSrImageBtn');
    const selected_day_field = $('#selected_day_field');
    selected_day_field.val(new Date().toISOString().substr(0, 10));
    const load_day_btn = $('#load_day_btn');
    load_day_btn.on('click', function () {
      loadData();
    });
    downloadGenericModalImageBtn.on('click', function () {
      downloadImage('original', genericModalOpenedImageLabelName, genericModalOpenedImageFileName);
    });
    downloadGenericModalSrImageBtn.on('click', function () {
      downloadImage('super_resolution', genericModalOpenedImageLabelName, genericModalOpenedImageFileName);
    });

    const load_earlier_day_btn = $('#load_earlier_day_btn');
    load_earlier_day_btn.on('click', function () {
      let date = new Date(selected_day_field.val());
      date.setDate(date.getDate() - 1);
      selected_day_field.val(date.toISOString().substr(0, 10));
      loadData();
    });
    const load_next_day_btn = $('#load_next_day_btn');
    load_next_day_btn.on('click', function () {
      let date = new Date(selected_day_field.val());
      date.setDate(date.getDate() + 1);
      selected_day_field.val(date.toISOString().substr(0, 10));
      loadData();
    });

    const licence_plate_flex_viewer = $('#licence_plate_flex_viewer');
    licence_plate_flex_viewer.on('click', 'img', function () {
      const id = $(this).attr('id');
      console.log(id);
      getObjectDetectionImage(id);
    });

    const faces_flex_viewer = $('#faces_flex_viewer');
    faces_flex_viewer.on('click', 'img', function () {
      const id = $(this).attr('id');
      if (confirm("Try detection again for this image?")) {
        tryFaceDetectionAgain(id);
      }
    });

    const face_grouping_names_flex_viewer = $('#face_grouping_names_flex_viewer');
    face_grouping_names_flex_viewer.on('click', 'button', function () {
      const name = $(this).attr('id');
      console.log('Name: ' + name + ' loadedFaceImg: ' + loadedFaceGroupingImage);
      moveFaceGroupingImage(name, loadedFaceGroupingImage);
    });
    const face_grouping_flex_viewer = $('#face_grouping_flex_viewer');
    face_grouping_flex_viewer.on('click', 'img', function () {
      loadedFaceGroupingImage = $(this).attr('id');
      face_grouping_names_flex_viewer.empty();
      faceGroupingNames.forEach(name => {
        face_grouping_names_flex_viewer.append(
          '<button id="' + name + '" type="button" class="btn btn-outline-secondary btn-sm mr-2">' + name + '</button>'
        )
      });
      face_grouping_names_flex_viewer.append(
        '<button id="delete" type="button" class="btn btn-outline-danger btn-sm mr-2">delete</button>'
      )
    });
    const delete_all_visible_faces_btn = $('#delete_all_visible_faces_btn');
    delete_all_visible_faces_btn.on('click', function () {
      if (confirm("Delete all remaining visible items, are you sure?")) {
        face_grouping_flex_viewer.find('img').each(function () {
          moveFaceGroupingImage('delete', this.id);
        });
      }
    });
    const train_face_model_btn = $('#train_face_model_btn');
    train_face_model_btn.on('click', function () {
      if (confirm("Send train face model training action?")) {
        trainFaceModel();
      }
    });
    const load_more_face_btn = $('#load_more_face_btn');
    load_more_face_btn.on('click', function () {
      getFaceGroupingImages();
    });
    const disable_polls_btn = $('#disable_polls_btn');
    disable_polls_btn.on('click', function () {
      cursorClick01Sound.play();
      pollsEnabled = (!pollsEnabled);
      disable_polls_btn.text(pollsEnabled ? 'Disable polls' : 'Enable polls');
    });

    const licence_plate_manager_modal = $('#licence_plate_manager_modal');
    const licence_plate_manager_modal_table = $('#licence_plate_manager_modal_table');
    const manage_licence_plates_btn = $('#manage_licence_plates_btn');
    manage_licence_plates_btn.on('click', function () {
      licence_plate_manager_modal.modal('show');
      getLicencePlates();
    });

    const add_licence_plate_collapse = $('#add_licence_plate_collapse');
    const new_plate_licence_plate = $('#new_plate_licence_plate');
    const new_plate_owner_name = $('#new_plate_owner_name');
    const new_plate_enabled = $('#new_plate_enabled');
    const new_plate_add_btn = $('#new_plate_add_btn');
    new_plate_add_btn.on('click', function () {
      manageLicencePlates(
        'add', null,
        String(new_plate_licence_plate.val()).replace('-', ''),
        new_plate_owner_name.val(),
        new_plate_enabled.is(':checked') === true ? 1 : 0,
        null
      );
    });
    const licence_plate_manager_modal_save_changes_btn = $('#licence_plate_manager_modal_save_changes_btn');
    licence_plate_manager_modal_save_changes_btn.on('click', function () {
      let changesArray = [];
      licence_plate_manager_modal_table.find('tr').each(function () {
        const element = $(this);
        const change = {
          id: Number(element.find('.pId').text()),
          licence_plate: element.find('.pLp').val(),
          owner_name: element.find('.pOn').val(),
          enabled: element.find('.pE').is(':checked') === true ? 1 : 0,
        };
        changesArray.push(change);
      });
      manageLicencePlates('changes', null, null, null, null, changesArray);
    });
    licence_plate_manager_modal_table.on('click', '.btn', function () {
      if (confirm("Sure to delete this licence plate record?")) {
        manageLicencePlates('remove', this.value, null, null, null, null);
      }
    });


    // Initial data load
    loadData();
    appendLoadingIndicator(object_detection_image_container);

    // Refresh
    pollInterval = setInterval(() => {
      if (pollsEnabled) {
        loadData();
      } else {
        console.info('Polls not enabled.');
      }
    }, (60 * 1000));

    function loadData() {

      // Image
      $.ajax({
        url: apiUrl + 'get/latest/object/detection/image',
        type: 'GET',
      }).done(function (data) {
        object_detection_image_container.empty();
        object_detection_image_container.append(
          '<img class="card-img-right zoom"' +
          ' style="width: 100%; height: 100%;"' +
          ' alt="Object detection image" src="' + data.data + '">'
        );
      });

      // Intelligence, includes all one day statistics, and valid detections
      $.ajax({
        url: apiUrl + 'get/intelligence',
        type: 'POST',
        data: {
          selectedDate: selected_day_field.val()
        }
      }).done(function (data) {

        show_instances_btn.text('IC ' + data.performance.instanceCount);
        resource_monitor.text('MEM ' + data.performance.memUse);
        storage_use_monitor.text('ST ' + data.performance.storageUse);

        // Donut labels
        $('#donut_chart').empty();
        new Morris.Donut({
          element: 'donut_chart',
          data: data.donut,
          resize: true,
          parseTime: false
        }).on('click', function (i, row) {
          const label_ = data.donut[i].label;
          loaded_label_info.text('You chose ' + label_ + ' label images.');
          loadedLabel = label_;
          loadLabelImages(label_);
        });

        // Activity chart
        $('#activity_chart').empty();
        new Morris.Bar({
          element: 'activity_chart',
          data: data.activity.data,
          xkey: data.activity.xkey,
          ykeys: data.activity.ykeys,
          labels: data.activity.labels,
          hideHover: true,
          resize: true,
          parseTime: false
        });
      });

      // License plate detection data, images and plate strings
      $.ajax({
        url: apiUrl + 'get/license/plate/detections',
        type: 'POST',
        data: {
          resultOption: 'limited_known',
          selectedDate: selected_day_field.val(),
          selectedDateStart: null,
          selectedDateEnd: null,
        }
      }).done(function (data) {
        licence_plate_flex_viewer.empty();
        if (data.licensePlates.length > 0) {
          data.licensePlates.forEach(licensePlate => {
            licence_plate_flex_viewer.append(
              '<div class="container mb-2">' +
              '  <div class="row">' +
              '    <div class="col mr-0 ml-0 pr-0 pl-0">' +
              '     <p class="lead text-center" style="font-weight: bold; background-color: #f4f4f4; width: 100%; height: 100%">'
              + licensePlate.detectionResult +
              '<br><a style="color: darkgreen; font-size: 12px;">' + licensePlate.detectionCorrected + '</a></p>' +
              '    </div>' +
              '    <div class="col mr-0 ml-0 pr-0 pl-0">' +
              '     <p class="lead text-center" style="font-weight: bold; background-color: #f4f4f4; width: 100%; height: 100%">'
              + licensePlate.ownerName + '</p>' +
              '    </div>\n' +
              '    <div class="col mr-0 ml-0 pr-0 pl-0">' +
              '     <img id="' + licensePlate.objectDetectionFileName + '" title="' + licensePlate.title + '" style="cursor: zoom-in; width: 120px; height: 80px; max-width: 120px; max-height: 120px;" src="' + licensePlate.image + '">' +
              '    </div>' +
              '  </div>' +
              '</div>' +
              '<hr>'
            );
            wheelzoom(document.getElementById(licensePlate.objectDetectionFileName));
          });
        }
      }).fail(function (error) {
        licence_plate_flex_viewer.empty();
      });

      $.ajax({
        url: apiUrl + 'get/faces',
        type: 'POST',
        data: {
          selectedDate: selected_day_field.val()
        }
      }).done(function (data) {
        // Faces
        faces_flex_viewer.empty();
        data.faces.forEach(face => {
          faces_flex_viewer.append(
            '<div style="margin: 5px;">' +
            '<img id="' + face.id + '" title="' + face.title + '" style="cursor: zoom-in; max-width: 120px; max-height: 120px;" src="' + face.image + '">' +
            '<p class="lead text-center" style="font-weight: bold; background-color: #f4f4f4; font-size: 10pt;">' + face.detectionResult + '</p>' +
            '</div>'
          );
          wheelzoom(document.getElementById(face.id));
        });
      }).fail(function (error) {
        faces_flex_viewer.empty();
      });

      getFaceGroupingImages();
    }

    function getFaceGroupingImages() {
      // Load face grouping images
      $.ajax({
        url: apiUrl + 'get/face/grouping/images',
        type: 'GET',
      }).done(function (data) {
        console.log(data);
        // Faces
        face_grouping_flex_viewer.empty();
        faceGroupingNames = data.names;
        data.images.forEach(imageData => {
          face_grouping_flex_viewer.append(
            '<img id="' + imageData.file + '" title="' + imageData.title + '" style="cursor: pointer; max-width:120px; max-height:120px; width: auto; height: auto;" class="zoom" src="' + imageData.image + '">'
          );
          wheelzoom(document.getElementById(imageData.file));
        });
      }).fail(function (error) {
        face_grouping_flex_viewer.empty();
      });
    }

    function loadWeeklyData() {

      $.ajax({
        url: apiUrl + 'get/weekly/intelligence',
        type: 'GET',
      }).done(function (data) {

        // Activity week chart
        $('#activity_week_chart').empty();
        new Morris.Bar({
          element: 'activity_week_chart',
          data: data.activityWeek.data,
          xkey: data.activityWeek.xkey,
          ykeys: data.activityWeek.ykeys,
          labels: data.activityWeek.labels,
          hideHover: true,
          resize: true,
          parseTime: false
        });
      });
    }

    function loadLabelImages(label) {
      label_image_flex_viewer.empty();
      label_image_flex_viewer.append('<div id="loading_indicator_place_holder" style="width: 100%"></div>');
      const loading_indicator_place_holder = $('#loading_indicator_place_holder');
      loading_indicator_place_holder.append('<div id="label_image_loading_indicator" ' +
        'style="width: 100%" class="text-center">' +
        '<div class="spinner-border" role="status">' +
        '<span class="sr-only">Loading...</span>' +
        '</div>' +
        '</div>');
      $.ajax({
        url: apiUrl + 'get/label/images',
        type: 'POST',
        data: {
          selectedDate: selected_day_field.val(),
          label: label
        },
      }).done(function (data) {
        data.images.forEach(imageData => {
          loading_indicator_place_holder.empty();
          label_image_flex_viewer.append(
            '<img id="' + imageData.file + '" title="' + imageData.title + '" style="cursor: pointer; max-width:120px; max-height:120px; width: auto; height: auto;" class="zoom" src="' + imageData.image + '">'
          );
          wheelzoom(document.getElementById(imageData.file));
        });
      }).fail(function (error) {
        loaded_label_info.text(error.status + ' ' + error.statusText);
        loading_indicator_place_holder.empty();
      });
    }


    function voiceIntelligence() {
      run(); // Initial run
      setInterval(function () {
        run();
      }, (30 * 1000));

      function run() {
        if (!bool_speaking) {
          $.ajax({
            url: apiUrl + 'get/voice/intelligence',
            type: 'GET',
          }).done(function (data) {
            if (data.message !== '') {
              bool_speaking = true;
              msg.text = data.message;
              speechSynthesis.speak(msg);
            }
          }).fail(function (error) {
            bool_speaking = false;
          });
        }
      }
    }


    function getSrModalData(image_file_name) {
      $.ajax({
        url: apiUrl + 'get/super/resolution/image',
        type: 'POST',
        data: {
          label: loadedLabel,
          imageFile: image_file_name
        },
      }).done(function (data) {
        generic_image_modal.modal('show');
        generic_modal_title.text(loadedLabel + ' - ' + image_file_name);
        genericModalOpenedImageLabelName = loadedLabel;
        genericModalOpenedImageFileName = image_file_name;
        generic_modal_description.empty();
        generic_modal_description.append(
          data.srImage ?
            '<div class="d-flex flex-row bd-highlight">' +
            '<div class="bd-highlight"><span class="badge badge-success">Super resolution</span></div>' +
            '<div class="ml-2 bd-highlight"><span class="badge badge-info">' + data.detectionResult + '</span></div>' +
            '<div class="ml-2 bd-highlight"><span class="badge badge-secondary">' + data.color + '</span></div>' +
            '</div>' +
            ' <p class="text-muted">This image is computed super resolution version.</p>'
            :
            '<div class="d-flex flex-row bd-highlight">' +
            '<div class="bd-highlight"><span class="badge badge-warning">Normal version</span></div>' +
            '<div class="ml-2 bd-highlight"><span class="badge badge-info">' + data.detectionResult + '</span></div>' +
            '<div class="ml-2 bd-highlight"><span class="badge badge-secondary">' + data.color + '</span></div>' +
            '</div>' +
            ' <p class="text-muted">No super resolution image.</p>'
        );
        generic_modal_image.attr("src", data.data);
      }).fail(function (error) {
        bool_speaking = false;
      });
    }


    function trainFaceModel() {
      $.ajax({
        url: apiUrl + 'train/face/model',
        type: 'GET',
      }).done(function (data) {
        alert(data);
      }).fail(function (error) {
        alert(error);
      });
    }

    function tryFaceDetectionAgain(id) {
      $.ajax({
        url: apiUrl + 'try/face/detection/again',
        type: 'POST',
        data: {
          id: id
        }
      }).done(function (data) {
        alert(data);
      }).fail(function (error) {
        alert(error);
      });
    }


    function moveFaceGroupingImage(name, loadedFaceGroupingImage) {
      $.ajax({
        url: apiUrl + 'move/face/grouping/image',
        type: 'POST',
        data: {
          name: name,
          rectFileName: loadedFaceGroupingImage
        },
      }).done(function (data) {
        face_grouping_flex_viewer.find('img[id="' + loadedFaceGroupingImage + '"]').remove();
        face_grouping_names_flex_viewer.empty();
      }).fail(function (error) {
        alert(error);
      });
    }


    function getLicencePlates() {
      licence_plate_manager_modal_table.empty();
      $.ajax({
        url: apiUrl + 'get/licence/plates',
        type: 'GET',
      }).done(function (data) {
        if (data.plates.length > 0) {
          data.plates.forEach(function (plate) {
            licence_plate_manager_modal_table.append(
              '<tr>' +
              '<th scope="row" class="pId">' + plate.id + '</th>' +
              '<td><input class="form-control pLp" type="text" value="' + plate.licence_plate + '"></td>' +
              '<td><input class="form-control pOn" type="text" value="' + plate.owner_name + '"></td>' +
              '<td style="text-align: center"><input class="form-check-input pE" type="checkbox" value="option1" ' + (plate.enabled === 1 ? 'checked' : '') + '></td>' +
              '<td><button type="button" value="' + plate.id + '" class="btn btn-danger" role="button">Delete</button></td>' +
              '</tr>'
            );
          });
        }
      }).fail(function (error) {
        console.log(error);
      });
    }


    /**
     *
     * @param {String} action_type ['add', 'remove', 'changes']
     * @param {Number} id
     * @param {String} licence_plate
     * @param {String} owner_name
     * @param {Number} enabled
     * @param {Array} saveChangesArray
     */
    function manageLicencePlates(action_type = 'add', id, licence_plate, owner_name, enabled, saveChangesArray) {
      $.ajax({
        url: apiUrl + 'manage/licence/plates',
        type: 'POST',
        data: {
          action_type: action_type,
          id: id,
          licence_plate: licence_plate,
          owner_name: owner_name,
          enabled: enabled,
          save_change_array: JSON.stringify(saveChangesArray),
        },
      }).done(function (data) {
        console.log(data);
        add_licence_plate_collapse.collapse('hide');
        getLicencePlates();
      }).fail(function (error) {
        alert(error);
      });
    }


    /**
     * Load object_detection image for given file name
     * @param object_detection_image_file_name
     */
    function getObjectDetectionImage(object_detection_image_file_name) {
      $.ajax({
        url: apiUrl + 'get/object/detection/image',
        type: 'POST',
        data: {
          objectDetectionImageFileName: object_detection_image_file_name
        },
      }).done(function (data) {
        generic_image_modal.modal('show');
        generic_modal_title.text(object_detection_image_file_name);
        genericModalOpenedImageFileName = null;
        generic_modal_description.empty();
        generic_modal_image.attr("src", data.data);
      }).fail(function (error) {
        alert(error);
      });
    }


    /**
     * Get object detection image name
     * @param cropped_image_name
     */
    function getObjectDetectionImageFileNameForCroppedImageName(cropped_image_name) {
      $.ajax({
        url: apiUrl + 'get/object/detection/image/for/cropped/image',
        type: 'POST',
        data: {
          croppedImageName: cropped_image_name
        },
      }).done(function (data) {
        getObjectDetectionImage(data.file_name);
      }).fail(function (error) {
        alert(error);
      });
    }


    function appendLoadingIndicator(jqueryElement) {
      jqueryElement.append('<div id="loading_indicator_place_holder" style="width: 100%"></div>');
      const loading_indicator_place_holder = $('#loading_indicator_place_holder');
      loading_indicator_place_holder.append('<div id="label_image_loading_indicator" ' +
        'style="width: 100%" class="text-center">' +
        '<div class="spinner-border" role="status">' +
        '<span class="sr-only">Loading...</span>' +
        '</div>' +
        '</div>');
    }


    /**
     * Download image
     * @param image_file_type ( original / super_resolution )
     * @param label
     * @param image_file_name
     */
    function downloadImage(image_file_type, label, image_file_name) {
      $.ajax({
        url: apiUrl + 'download/image',
        type: 'POST',
        data: {
          imageFileType: image_file_type,
          label: label,
          imageFileName: image_file_name,
        },
      }).done(function (data) {
        let a = document.createElement("a");
        a.href = data.data;
        a.download = image_file_name;
        a.click();
      }).fail(function (error) {
        alert(error);
      });
    }


    function getInstanceDetails() {
      $.ajax({
        url: apiUrl + 'get/instance/details',
        type: 'GET',
      }).done(function (data) {
        instance_modal.modal('show');
        instance_modal_content.empty();
        data.forEach(instance => {
          instance_modal_content.append(
            '<tr>' +
            '<th scope="row">' + instance.id + '</th>' +
            '<td>' + instance.process_name + '</td>' +
            '<td>N/A</td>' +
            '<td>' + instance.updatedAt + '</td>' +
            '</tr>'
          )
        });
      }).fail(function (error) {
        alert(error);
      });
    }


  });


</script>

</body>
</html>
